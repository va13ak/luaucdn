local luaucdn = {
  
}

luaucdn.UCDN_EAST_ASIAN_F = 0
luaucdn.UCDN_EAST_ASIAN_H = 1
luaucdn.UCDN_EAST_ASIAN_W = 2
luaucdn.UCDN_EAST_ASIAN_NA = 3
luaucdn.UCDN_EAST_ASIAN_A = 4
luaucdn.UCDN_EAST_ASIAN_N = 5

luaucdn.UCDN_SCRIPT_COMMON = 0
luaucdn.UCDN_SCRIPT_LATIN = 1
luaucdn.UCDN_SCRIPT_GREEK = 2
luaucdn.UCDN_SCRIPT_CYRILLIC = 3
luaucdn.UCDN_SCRIPT_ARMENIAN = 4
luaucdn.UCDN_SCRIPT_HEBREW = 5
luaucdn.UCDN_SCRIPT_ARABIC = 6
luaucdn.UCDN_SCRIPT_SYRIAC = 7
luaucdn.UCDN_SCRIPT_THAANA = 8
luaucdn.UCDN_SCRIPT_DEVANAGARI = 9
luaucdn.UCDN_SCRIPT_BENGALI = 10
luaucdn.UCDN_SCRIPT_GURMUKHI = 11
luaucdn.UCDN_SCRIPT_GUJARATI = 12
luaucdn.UCDN_SCRIPT_ORIYA = 13
luaucdn.UCDN_SCRIPT_TAMIL = 14
luaucdn.UCDN_SCRIPT_TELUGU = 15
luaucdn.UCDN_SCRIPT_KANNADA = 16
luaucdn.UCDN_SCRIPT_MALAYALAM = 17
luaucdn.UCDN_SCRIPT_SINHALA = 18
luaucdn.UCDN_SCRIPT_THAI = 19
luaucdn.UCDN_SCRIPT_LAO = 20
luaucdn.UCDN_SCRIPT_TIBETAN = 21
luaucdn.UCDN_SCRIPT_MYANMAR = 22
luaucdn.UCDN_SCRIPT_GEORGIAN = 23
luaucdn.UCDN_SCRIPT_HANGUL = 24
luaucdn.UCDN_SCRIPT_ETHIOPIC = 25
luaucdn.UCDN_SCRIPT_CHEROKEE = 26
luaucdn.UCDN_SCRIPT_CANADIAN_ABORIGINAL = 27
luaucdn.UCDN_SCRIPT_OGHAM = 28
luaucdn.UCDN_SCRIPT_RUNIC = 29
luaucdn.UCDN_SCRIPT_KHMER = 30
luaucdn.UCDN_SCRIPT_MONGOLIAN = 31
luaucdn.UCDN_SCRIPT_HIRAGANA = 32
luaucdn.UCDN_SCRIPT_KATAKANA = 33
luaucdn.UCDN_SCRIPT_BOPOMOFO = 34
luaucdn.UCDN_SCRIPT_HAN = 35
luaucdn.UCDN_SCRIPT_YI = 36
luaucdn.UCDN_SCRIPT_OLD_ITALIC = 37
luaucdn.UCDN_SCRIPT_GOTHIC = 38
luaucdn.UCDN_SCRIPT_DESERET = 39
luaucdn.UCDN_SCRIPT_INHERITED = 40
luaucdn.UCDN_SCRIPT_TAGALOG = 41
luaucdn.UCDN_SCRIPT_HANUNOO = 42
luaucdn.UCDN_SCRIPT_BUHID = 43
luaucdn.UCDN_SCRIPT_TAGBANWA = 44
luaucdn.UCDN_SCRIPT_LIMBU = 45
luaucdn.UCDN_SCRIPT_TAI_LE = 46
luaucdn.UCDN_SCRIPT_LINEAR_B = 47
luaucdn.UCDN_SCRIPT_UGARITIC = 48
luaucdn.UCDN_SCRIPT_SHAVIAN = 49
luaucdn.UCDN_SCRIPT_OSMANYA = 50
luaucdn.UCDN_SCRIPT_CYPRIOT = 51
luaucdn.UCDN_SCRIPT_BRAILLE = 52
luaucdn.UCDN_SCRIPT_BUGINESE = 53
luaucdn.UCDN_SCRIPT_COPTIC = 54
luaucdn.UCDN_SCRIPT_NEW_TAI_LUE = 55
luaucdn.UCDN_SCRIPT_GLAGOLITIC = 56
luaucdn.UCDN_SCRIPT_TIFINAGH = 57
luaucdn.UCDN_SCRIPT_SYLOTI_NAGRI = 58
luaucdn.UCDN_SCRIPT_OLD_PERSIAN = 59
luaucdn.UCDN_SCRIPT_KHAROSHTHI = 60
luaucdn.UCDN_SCRIPT_BALINESE = 61
luaucdn.UCDN_SCRIPT_CUNEIFORM = 62
luaucdn.UCDN_SCRIPT_PHOENICIAN = 63
luaucdn.UCDN_SCRIPT_PHAGS_PA = 64
luaucdn.UCDN_SCRIPT_NKO = 65
luaucdn.UCDN_SCRIPT_SUNDANESE = 66
luaucdn.UCDN_SCRIPT_LEPCHA = 67
luaucdn.UCDN_SCRIPT_OL_CHIKI = 68
luaucdn.UCDN_SCRIPT_VAI = 69
luaucdn.UCDN_SCRIPT_SAURASHTRA = 70
luaucdn.UCDN_SCRIPT_KAYAH_LI = 71
luaucdn.UCDN_SCRIPT_REJANG = 72
luaucdn.UCDN_SCRIPT_LYCIAN = 73
luaucdn.UCDN_SCRIPT_CARIAN = 74
luaucdn.UCDN_SCRIPT_LYDIAN = 75
luaucdn.UCDN_SCRIPT_CHAM = 76
luaucdn.UCDN_SCRIPT_TAI_THAM = 77
luaucdn.UCDN_SCRIPT_TAI_VIET = 78
luaucdn.UCDN_SCRIPT_AVESTAN = 79
luaucdn.UCDN_SCRIPT_EGYPTIAN_HIEROGLYPHS = 80
luaucdn.UCDN_SCRIPT_SAMARITAN = 81
luaucdn.UCDN_SCRIPT_LISU = 82
luaucdn.UCDN_SCRIPT_BAMUM = 83
luaucdn.UCDN_SCRIPT_JAVANESE = 84
luaucdn.UCDN_SCRIPT_MEETEI_MAYEK = 85
luaucdn.UCDN_SCRIPT_IMPERIAL_ARAMAIC = 86
luaucdn.UCDN_SCRIPT_OLD_SOUTH_ARABIAN = 87
luaucdn.UCDN_SCRIPT_INSCRIPTIONAL_PARTHIAN = 88
luaucdn.UCDN_SCRIPT_INSCRIPTIONAL_PAHLAVI = 89
luaucdn.UCDN_SCRIPT_OLD_TURKIC = 90
luaucdn.UCDN_SCRIPT_KAITHI = 91
luaucdn.UCDN_SCRIPT_BATAK = 92
luaucdn.UCDN_SCRIPT_BRAHMI = 93
luaucdn.UCDN_SCRIPT_MANDAIC = 94
luaucdn.UCDN_SCRIPT_CHAKMA = 95
luaucdn.UCDN_SCRIPT_MEROITIC_CURSIVE = 96
luaucdn.UCDN_SCRIPT_MEROITIC_HIEROGLYPHS = 97
luaucdn.UCDN_SCRIPT_MIAO = 98
luaucdn.UCDN_SCRIPT_SHARADA = 99
luaucdn.UCDN_SCRIPT_SORA_SOMPENG = 100
luaucdn.UCDN_SCRIPT_TAKRI = 101
luaucdn.UCDN_SCRIPT_UNKNOWN = 102
luaucdn.UCDN_SCRIPT_BASSA_VAH = 103
luaucdn.UCDN_SCRIPT_CAUCASIAN_ALBANIAN = 104
luaucdn.UCDN_SCRIPT_DUPLOYAN = 105
luaucdn.UCDN_SCRIPT_ELBASAN = 106
luaucdn.UCDN_SCRIPT_GRANTHA = 107
luaucdn.UCDN_SCRIPT_KHOJKI = 108
luaucdn.UCDN_SCRIPT_KHUDAWADI = 109
luaucdn.UCDN_SCRIPT_LINEAR_A = 110
luaucdn.UCDN_SCRIPT_MAHAJANI = 111
luaucdn.UCDN_SCRIPT_MANICHAEAN = 112
luaucdn.UCDN_SCRIPT_MENDE_KIKAKUI = 113
luaucdn.UCDN_SCRIPT_MODI = 114
luaucdn.UCDN_SCRIPT_MRO = 115
luaucdn.UCDN_SCRIPT_NABATAEAN = 116
luaucdn.UCDN_SCRIPT_OLD_NORTH_ARABIAN = 117
luaucdn.UCDN_SCRIPT_OLD_PERMIC = 118
luaucdn.UCDN_SCRIPT_PAHAWH_HMONG = 119
luaucdn.UCDN_SCRIPT_PALMYRENE = 120
luaucdn.UCDN_SCRIPT_PAU_CIN_HAU = 121
luaucdn.UCDN_SCRIPT_PSALTER_PAHLAVI = 122
luaucdn.UCDN_SCRIPT_SIDDHAM = 123
luaucdn.UCDN_SCRIPT_TIRHUTA = 124
luaucdn.UCDN_SCRIPT_WARANG_CITI = 125
luaucdn.UCDN_SCRIPT_AHOM = 126
luaucdn.UCDN_SCRIPT_ANATOLIAN_HIEROGLYPHS = 127
luaucdn.UCDN_SCRIPT_HATRAN = 128
luaucdn.UCDN_SCRIPT_MULTANI = 129
luaucdn.UCDN_SCRIPT_OLD_HUNGARIAN = 130
luaucdn.UCDN_SCRIPT_SIGNWRITING = 131
luaucdn.UCDN_SCRIPT_ADLAM = 132
luaucdn.UCDN_SCRIPT_BHAIKSUKI = 133
luaucdn.UCDN_SCRIPT_MARCHEN = 134
luaucdn.UCDN_SCRIPT_NEWA = 135
luaucdn.UCDN_SCRIPT_OSAGE = 136
luaucdn.UCDN_SCRIPT_TANGUT = 137
luaucdn.UCDN_SCRIPT_MASARAM_GONDI = 138
luaucdn.UCDN_SCRIPT_NUSHU = 139
luaucdn.UCDN_SCRIPT_SOYOMBO = 140
luaucdn.UCDN_SCRIPT_ZANABAZAR_SQUARE = 141

luaucdn.UCDN_LINEBREAK_CLASS_OP = 0
luaucdn.UCDN_LINEBREAK_CLASS_CL = 1
luaucdn.UCDN_LINEBREAK_CLASS_CP = 2
luaucdn.UCDN_LINEBREAK_CLASS_QU = 3
luaucdn.UCDN_LINEBREAK_CLASS_GL = 4
luaucdn.UCDN_LINEBREAK_CLASS_NS = 5
luaucdn.UCDN_LINEBREAK_CLASS_EX = 6
luaucdn.UCDN_LINEBREAK_CLASS_SY = 7
luaucdn.UCDN_LINEBREAK_CLASS_IS = 8
luaucdn.UCDN_LINEBREAK_CLASS_PR = 9
luaucdn.UCDN_LINEBREAK_CLASS_PO = 10
luaucdn.UCDN_LINEBREAK_CLASS_NU = 11
luaucdn.UCDN_LINEBREAK_CLASS_AL = 12
luaucdn.UCDN_LINEBREAK_CLASS_HL = 13
luaucdn.UCDN_LINEBREAK_CLASS_ID = 14
luaucdn.UCDN_LINEBREAK_CLASS_IN = 15
luaucdn.UCDN_LINEBREAK_CLASS_HY = 16
luaucdn.UCDN_LINEBREAK_CLASS_BA = 17
luaucdn.UCDN_LINEBREAK_CLASS_BB = 18
luaucdn.UCDN_LINEBREAK_CLASS_B2 = 19
luaucdn.UCDN_LINEBREAK_CLASS_ZW = 20
luaucdn.UCDN_LINEBREAK_CLASS_CM = 21
luaucdn.UCDN_LINEBREAK_CLASS_WJ = 22
luaucdn.UCDN_LINEBREAK_CLASS_H2 = 23
luaucdn.UCDN_LINEBREAK_CLASS_H3 = 24
luaucdn.UCDN_LINEBREAK_CLASS_JL = 25
luaucdn.UCDN_LINEBREAK_CLASS_JV = 26
luaucdn.UCDN_LINEBREAK_CLASS_JT = 27
luaucdn.UCDN_LINEBREAK_CLASS_RI = 28
luaucdn.UCDN_LINEBREAK_CLASS_AI = 29
luaucdn.UCDN_LINEBREAK_CLASS_BK = 30
luaucdn.UCDN_LINEBREAK_CLASS_CB = 31
luaucdn.UCDN_LINEBREAK_CLASS_CJ = 32
luaucdn.UCDN_LINEBREAK_CLASS_CR = 33
luaucdn.UCDN_LINEBREAK_CLASS_LF = 34
luaucdn.UCDN_LINEBREAK_CLASS_NL = 35
luaucdn.UCDN_LINEBREAK_CLASS_SA = 36
luaucdn.UCDN_LINEBREAK_CLASS_SG = 37
luaucdn.UCDN_LINEBREAK_CLASS_SP = 38
luaucdn.UCDN_LINEBREAK_CLASS_XX = 39
luaucdn.UCDN_LINEBREAK_CLASS_ZWJ = 40
luaucdn.UCDN_LINEBREAK_CLASS_EB = 41
luaucdn.UCDN_LINEBREAK_CLASS_EM = 42

luaucdn.UCDN_GENERAL_CATEGORY_CC = 0
luaucdn.UCDN_GENERAL_CATEGORY_CF = 1
luaucdn.UCDN_GENERAL_CATEGORY_CN = 2
luaucdn.UCDN_GENERAL_CATEGORY_CO = 3
luaucdn.UCDN_GENERAL_CATEGORY_CS = 4
luaucdn.UCDN_GENERAL_CATEGORY_LL = 5
luaucdn.UCDN_GENERAL_CATEGORY_LM = 6
luaucdn.UCDN_GENERAL_CATEGORY_LO = 7
luaucdn.UCDN_GENERAL_CATEGORY_LT = 8
luaucdn.UCDN_GENERAL_CATEGORY_LU = 9
luaucdn.UCDN_GENERAL_CATEGORY_MC = 10
luaucdn.UCDN_GENERAL_CATEGORY_ME = 11
luaucdn.UCDN_GENERAL_CATEGORY_MN = 12
luaucdn.UCDN_GENERAL_CATEGORY_ND = 13
luaucdn.UCDN_GENERAL_CATEGORY_NL = 14
luaucdn.UCDN_GENERAL_CATEGORY_NO = 15
luaucdn.UCDN_GENERAL_CATEGORY_PC = 16
luaucdn.UCDN_GENERAL_CATEGORY_PD = 17
luaucdn.UCDN_GENERAL_CATEGORY_PE = 18
luaucdn.UCDN_GENERAL_CATEGORY_PF = 19
luaucdn.UCDN_GENERAL_CATEGORY_PI = 20
luaucdn.UCDN_GENERAL_CATEGORY_PO = 21
luaucdn.UCDN_GENERAL_CATEGORY_PS = 22
luaucdn.UCDN_GENERAL_CATEGORY_SC = 23
luaucdn.UCDN_GENERAL_CATEGORY_SK = 24
luaucdn.UCDN_GENERAL_CATEGORY_SM = 25
luaucdn.UCDN_GENERAL_CATEGORY_SO = 26
luaucdn.UCDN_GENERAL_CATEGORY_ZL = 27
luaucdn.UCDN_GENERAL_CATEGORY_ZP = 28
luaucdn.UCDN_GENERAL_CATEGORY_ZS = 29

luaucdn.UCDN_BIDI_CLASS_L = 0
luaucdn.UCDN_BIDI_CLASS_LRE = 1
luaucdn.UCDN_BIDI_CLASS_LRO = 2
luaucdn.UCDN_BIDI_CLASS_R = 3
luaucdn.UCDN_BIDI_CLASS_AL = 4
luaucdn.UCDN_BIDI_CLASS_RLE = 5
luaucdn.UCDN_BIDI_CLASS_RLO = 6
luaucdn.UCDN_BIDI_CLASS_PDF = 7
luaucdn.UCDN_BIDI_CLASS_EN = 8
luaucdn.UCDN_BIDI_CLASS_ES = 9
luaucdn.UCDN_BIDI_CLASS_ET = 10
luaucdn.UCDN_BIDI_CLASS_AN = 11
luaucdn.UCDN_BIDI_CLASS_CS = 12
luaucdn.UCDN_BIDI_CLASS_NSM = 13
luaucdn.UCDN_BIDI_CLASS_BN = 14
luaucdn.UCDN_BIDI_CLASS_B = 15
luaucdn.UCDN_BIDI_CLASS_S = 16
luaucdn.UCDN_BIDI_CLASS_WS = 17
luaucdn.UCDN_BIDI_CLASS_ON = 18
luaucdn.UCDN_BIDI_CLASS_LRI = 19
luaucdn.UCDN_BIDI_CLASS_RLI = 20
luaucdn.UCDN_BIDI_CLASS_FSI = 21
luaucdn.UCDN_BIDI_CLASS_PDI = 22

luaucdn.UCDN_BIDI_PAIRED_BRACKET_TYPE_OPEN = 0
luaucdn.UCDN_BIDI_PAIRED_BRACKET_TYPE_CLOSE = 1
luaucdn.UCDN_BIDI_PAIRED_BRACKET_TYPE_NONE = 2



local ucdnDB = require( "luaucdn.ucdn_db" )

local bit = require "plugin.bit"

local band = bit.band
local lshift, rshift = bit.lshift, bit.rshift

local function get_ucd_record( code )
    local index, offset;

    if (code >= 0x110000) then
        index = 0;
    else
        index  = lshift( ucdnDB.index0[ rshift( code, ucdnDB.SHIFT1 + ucdnDB.SHIFT2 ) + 1 ], ucdnDB.SHIFT1 );
        offset = band( rshift( code, ucdnDB.SHIFT2 ), lshift(1, ucdnDB.SHIFT1) - 1 );
        index  = lshift( ucdnDB.index1[ index + offset + 1 ], ucdnDB.SHIFT2 );
        offset = band( code, lshift(1, ucdnDB.SHIFT2) - 1 );
        index  = ucdnDB.index2[ index + offset + 1 ];
    end

    return ucdnDB.ucd_records[ index + 1 ];
end

local function get_decomp_record( code )
    local index, offset;

    if (code >= 0x110000) then
        index = 0;
    else
        index  = lshift( ucdnDB.decomp_index0[ rshift( code, ucdnDB.DECOMP_SHIFT1 + ucdnDB.DECOMP_SHIFT2 ) + 1 ], ucdnDB.DECOMP_SHIFT1 );
        offset = band( rshift( code, ucdnDB.DECOMP_SHIFT2), ( lshift(1, ucdnDB.DECOMP_SHIFT1) - 1) );
        index  = lshift( ucdnDB.decomp_index1[ index + offset + 1 ], ucdnDB.DECOMP_SHIFT2 );
        offset = band( code, lshift( 1, ucdnDB.DECOMP_SHIFT2 ) - 1 );
        index  = ucdnDB.decomp_index2[ index + offset + 1 ];
    end

    return ucdnDB.decomp_data[ index + 1 ];
end



function luaucdn.get_unicode_version( ... )
  return ucdnDB.UNIDATA_VERSION
end

function luaucdn.get_bidi_class( code )
  return get_ucd_record( code )[ 3 ]
end

-- rewriting only part needed for luabidi
-- without decoding part
function luaucdn.compat_decompose( code )
    local i, len;
    local rec = get_decomp_record(code);
    len = rshift( rec[ 1 ], 8 );

    if (len == 0) then
        return { 0 };
    end
    --[[
    rec++;
    for (i = 0; i < len; i++) do
        decomposed[i] = decode_utf16(&rec);
    end
    ]]--
    return { len };
end

function luaucdn.paired_bracket_type( code )
    local pbt = ucdnDB.bracket_pairs[ code ]
    if pbt then
        return pbt[ 3 ]
    else
        return luaucdn.UCDN_BIDI_PAIRED_BRACKET_TYPE_NONE
    end
end

function luaucdn.paired_bracket( code )
    local pb = ucdnDB.bracket_pairs[ code ]
    if pb then
        return pb[ 2 ]
    else
        return code
    end
end
--[[
int compat_decompose(lua_State *L) {
  uint32_t c = lua_tointeger(L, 1);

  uint32_t decomposed[18];
  unsigned int len = ucdn_compat_decompose(c, decomposed);

  lua_newtable(L);
  unsigned int i;
  for (i = 0; i < len; i++) {
    lua_pushinteger(L, i+1);
    lua_pushinteger(L, decomposed[i]);
    lua_settable(L,-3);
  }

  return 1;
}

static const struct luaL_Reg lib_table [] = {
  {"get_unicode_version", get_unicode_version},
  {"get_bidi_class", get_bidi_class},
  {"paired_bracket_type", paired_bracket_type},
  {"paired_bracket", paired_bracket},
  {"compat_decompose", compat_decompose},
  {NULL, NULL}
};
--]]

return luaucdn